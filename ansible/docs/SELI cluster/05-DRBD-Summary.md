# DRBD Component Summary

## Overview
DRBD (Distributed Replicated Block Device) provides real-time block-level replication between cluster nodes for high availability storage.

## DRBD Version & Status
- **Version**: 9.2.14 (kernel module) + 9.32.0 (userspace utilities)
- **Protocol**: Protocol C (synchronous replication - writes acknowledged on both nodes)
- **Connection**: Over bond-int (192.168.0.1/2) on dedicated network
- **Total Resources**: 22 DRBD resources configured

## Resource Status Overview
Most resources show:
- **State**: UpToDate/UpToDate (both nodes synchronized)
- **Connection**: Established
- **Typical Pattern**: Primary/Secondary (one VM running on one node)
- **Dual-Primary**: Enabled for local_home_disk (both nodes Primary)

## Example Resources

### VM Storage (Primary/Secondary pattern)
- **seliicvm01755_sda**: Primary on seliics02501, Secondary on seliics02058
- **seliius30752_sda**: Primary on seliics02058, Secondary on seliics02501 (VM running on 058)
- Each VM has dedicated DRBD resource named `{vmname}_sda`

### Shared Storage (Dual-Primary)
- **local_home_disk**: Both nodes Primary (allow-two-primaries: yes)

## Network Configuration
```yaml
Connection Settings:
  - IP: 192.168.0.2:7000 (seliics02501) â†” 192.168.0.1:7000 (seliics02058)
  - Protocol: C (synchronous)
  - Authentication: HMAC-SHA1 with shared secret
  - Max buffers: 8000
  - Send buffer: 2 MB
  - C-max-rate: 4194304 (4 GB/s cap)
```

## Resource Configuration Template
```
resource <vm_name>_sda {
    on seliics02501 {
        node-id 1;
        device minor 10XX;
        disk /dev/linstor_lv_*_pool/<vm_name>_sda_00000;
        meta-disk internal;
    }
    on seliics02058 {
        node-id 0;
        device minor 10XX;
        disk /dev/linstor_lv_*_pool/<vm_name>_sda_00000;
        meta-disk internal;
    }
    connection {
        protocol C;
        allow-two-primaries no;  # or yes for shared storage
        after-sb-2pri disconnect;
    }
}
```

## Key Performance Settings
- **Activity Log Extents**: 6007 (for faster resync)
- **Disk barriers**: Disabled (no)
- **Disk flushes**: Disabled (no) - SSDs handle this
- **Discard zeroes aligned**: Yes (TRIM support)
- **RS discard granularity**: 1048576 (1 MB)

## Ansible Automation Notes

### Status Checking
```yaml
- name: Get DRBD status
  command: drbdadm status
  register: drbd_status

- name: Check specific resource
  command: drbdadm status {{ resource_name }}
```

### Resource Management
```yaml
- name: Promote DRBD resource
  command: drbdadm primary {{ resource_name }}

- name: Demote DRBD resource
  command: drbdadm secondary {{ resource_name }}

- name: Force DRBD primary (danger!)
  command: drbdadm primary --force {{ resource_name }}
```

### Common Operations
```yaml
- name: Verify DRBD config
  command: drbdadm dump {{ resource_name }}

- name: Get connection state
  command: drbdadm cstate {{ resource_name }}

- name: Get disk state
  command: drbdadm dstate {{ resource_name }}
```

## Important Notes
- **Split-brain protection**: after-sb-2pri set to disconnect
- **Auto-promote**: 10 second timeout for automatic promotion
- **Quorum**: Disabled (2-node cluster uses other mechanisms)
- **Config files**: Generated by LINSTOR in `/var/lib/linstor.d/*.res`
- **Manual config**: `/etc/drbd.conf` and `/etc/drbd.d/`

## Monitoring Points
- Connection state: Should be "Established"
- Disk state: Should be "UpToDate/UpToDate"
- Role: Primary/Secondary (or both Primary for dual-primary resources)
- Replication lag: Check `drbdsetup status --verbose`

## Configuration Files
- Main config: `/etc/drbd.conf`
- Resource configs: `/var/lib/linstor.d/*.res` (managed by LINSTOR)
- Global config: `/etc/drbd.d/global_common.conf`
