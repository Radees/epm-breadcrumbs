---
# Pre-installation checks

- name: Ensure apt is available
  ansible.builtin.stat:
    path: /usr/bin/apt
  register: apt_available

- name: Check apt availability
  ansible.builtin.assert:
    that:
      - apt_available.stat.exists
    fail_msg: "apt package manager not found"
    success_msg: "apt package manager is available"

- name: Configure custom apt settings if enabled
  ansible.builtin.template:
    src: apt.conf.j2
    dest: /etc/apt/apt.conf.d/99custom
    owner: root
    group: root
    mode: '0644'
  when: ubuntu_packages_custom_apt_config | bool

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ ubuntu_packages_cache_valid_time }}"
  register: apt_update
  until: apt_update is success
  retries: "{{ ubuntu_packages_retry_count }}"
  delay: "{{ ubuntu_packages_retry_delay }}"
