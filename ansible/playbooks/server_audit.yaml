---
# ============================================================================
# Server Configuration Audit Playbook
# ============================================================================
# Description: Comprehensive server audit playbook for cluster nodes
# Purpose: Checks critical server configurations including:
#          - Network settings
#          - NTP status
#          - DNS settings
#          - Authentication settings
#          - User group memberships
#          - KVM virtual machine inventory
#          - OneIdentity vastool
#          - LINBIT Storage (DRBD/linstor)
#
# Usage: ansible-playbook playbooks/server_audit.yaml
#        ansible-playbook playbooks/server_audit.yaml --tags network,ntp
# ============================================================================

- name: Server Configuration Audit
  hosts: cluster_nodes
  become: true
  gather_facts: true

  vars:
    audit_output_dir: /tmp/server_audit
    audit_timestamp: "{{ ansible_date_time.iso8601 }}"
    target_user: "{{ ansible_env.USER | default('root') }}"

  tasks:
    # ========================================
    # Network Settings Check
    # ========================================
    - name: Gather network information
      tags: [network, always]
      block:
        - name: Get IP configuration
          ansible.builtin.command: ip addr
          register: ip_config
          changed_when: false

        - name: Get routing table
          ansible.builtin.command: ip route
          register: routing_table
          changed_when: false

        - name: Get open ports
          ansible.builtin.shell: ss -tuln
          register: open_ports
          changed_when: false

        - name: Store network information
          ansible.builtin.set_fact:
            network_info:
              ip_config: "{{ ip_config.stdout_lines }}"
              routing_table: "{{ routing_table.stdout_lines }}"
              open_ports: "{{ open_ports.stdout_lines }}"

      rescue:
        - name: Log network check failure
          ansible.builtin.debug:
            msg: "Network information gathering failed: {{ ansible_failed_result.msg }}"

    # ========================================
    # NTP Status Check
    # ========================================
    - name: Check NTP status
      tags: [ntp, time]
      block:
        - name: Check if chronyd is running
          ansible.builtin.service:
            name: chronyd
            state: started
          register: chronyd_status
          ignore_errors: true

        - name: Check if ntpd is running
          ansible.builtin.service:
            name: ntpd
            state: started
          register: ntpd_status
          ignore_errors: true

        - name: Get NTP synchronization status
          ansible.builtin.shell: chronyc tracking || ntpq -p
          register: ntp_sync
          changed_when: false
          ignore_errors: true

        - name: Store NTP information
          ansible.builtin.set_fact:
            ntp_info:
              chronyd_active: "{{ chronyd_status is defined and not chronyd_status.failed }}"
              ntpd_active: "{{ ntpd_status is defined and not ntpd_status.failed }}"
              sync_status: "{{ ntp_sync.stdout_lines | default([]) }}"

      rescue:
        - name: Log NTP check failure
          ansible.builtin.debug:
            msg: "NTP status check failed"

    # ========================================
    # DNS Settings Check
    # ========================================
    - name: Check DNS configuration
      tags: [dns, network]
      block:
        - name: Get DNS resolver configuration
          ansible.builtin.slurp:
            src: /etc/resolv.conf
          register: resolv_conf_content

        - name: Parse resolv.conf
          ansible.builtin.set_fact:
            resolv_conf: "{{ (resolv_conf_content.content | b64decode).split('\n') }}"

        - name: Test DNS resolution
          ansible.builtin.shell: |
            for d in google.com example.com; do
              dig +short $d || echo "Failed to resolve $d"
            done
          register: dns_test
          changed_when: false
          ignore_errors: true

        - name: Store DNS information
          ansible.builtin.set_fact:
            dns_info:
              resolv_conf: "{{ resolv_conf }}"
              resolution_test: "{{ dns_test.stdout_lines }}"

      rescue:
        - name: Log DNS check failure
          ansible.builtin.debug:
            msg: "DNS configuration check failed"

    # ========================================
    # Authentication Settings Check
    # ========================================
    - name: Check authentication settings
      tags: [auth, security]
      block:
        - name: Check SSSD configuration
          ansible.builtin.stat:
            path: /etc/sssd/sssd.conf
          register: sssd_conf

        - name: Get SSSD configuration details
          ansible.builtin.slurp:
            src: /etc/sssd/sssd.conf
          register: sssd_content
          when: sssd_conf.stat.exists

        - name: Check for LDAP configuration
          ansible.builtin.stat:
            path: /etc/openldap/ldap.conf
          register: ldap_conf

        - name: Get LDAP configuration details
          ansible.builtin.slurp:
            src: /etc/openldap/ldap.conf
          register: ldap_content
          when: ldap_conf.stat.exists

        - name: Store authentication information
          ansible.builtin.set_fact:
            auth_info:
              sssd_present: "{{ sssd_conf.stat.exists | default(false) }}"
              sssd_config: "{{ (sssd_content.content | b64decode).split('\n') if sssd_conf.stat.exists else [] }}"
              ldap_present: "{{ ldap_conf.stat.exists | default(false) }}"
              ldap_config: "{{ (ldap_content.content | b64decode).split('\n') if ldap_conf.stat.exists else [] }}"

      rescue:
        - name: Log authentication check failure
          ansible.builtin.debug:
            msg: "Authentication settings check failed"

    # ========================================
    # User Group Membership Check
    # ========================================
    - name: Get specific user group memberships
      tags: [users, security]
      block:
        - name: Get user groups
          ansible.builtin.command: groups {{ target_user }}
          register: user_groups
          changed_when: false

        - name: Check sudo group membership
          ansible.builtin.set_fact:
            is_sudo_member: "{{ 'sudo' in user_groups.stdout }}"

        - name: Check wheel group membership
          ansible.builtin.set_fact:
            is_wheel_member: "{{ 'wheel' in user_groups.stdout }}"

        - name: Check libvirt group membership
          ansible.builtin.set_fact:
            is_libvirt_member: "{{ 'libvirt' in user_groups.stdout }}"

        - name: Store user group information
          ansible.builtin.set_fact:
            user_groups_info:
              username: "{{ target_user }}"
              all_groups: "{{ user_groups.stdout }}"
              sudo_member: "{{ is_sudo_member }}"
              wheel_member: "{{ is_wheel_member }}"
              libvirt_member: "{{ is_libvirt_member }}"

      rescue:
        - name: Log user group check failure
          ansible.builtin.debug:
            msg: "User group membership check failed"

    # ========================================
    # KVM Virtual Machines Inventory
    # ========================================
    - name: Check KVM virtual machines
      tags: [kvm, virtualization]
      block:
        - name: Check if libvirtd is running
          ansible.builtin.service:
            name: libvirtd
            state: started
          register: libvirtd_status
          ignore_errors: true

        - name: List all KVM virtual machines
          ansible.builtin.shell: virsh list --all
          register: vm_list
          changed_when: false
          ignore_errors: true
          when: libvirtd_status is succeeded

        - name: Get VM names
          ansible.builtin.shell: virsh list --name --all
          register: vm_names
          changed_when: false
          ignore_errors: true
          when: libvirtd_status is succeeded

        - name: Get detailed VM information
          ansible.builtin.shell: |
            for vm in $(virsh list --name --all); do
              if [ -n "$vm" ]; then
                virsh dominfo "$vm"
                echo '---'
              fi
            done
          register: vm_details
          changed_when: false
          ignore_errors: true
          when: libvirtd_status is succeeded

        - name: Store KVM virtual machine information
          ansible.builtin.set_fact:
            kvm_info:
              libvirtd_active: "{{ libvirtd_status is succeeded }}"
              vm_list: "{{ vm_list.stdout_lines | default([]) }}"
              vm_names: "{{ vm_names.stdout_lines | default([]) | select('match', '.+') | list }}"
              vm_details: "{{ vm_details.stdout_lines | default([]) }}"

      rescue:
        - name: Log KVM check failure
          ansible.builtin.debug:
            msg: "KVM virtual machine check failed"

    # ========================================
    # OneIdentity vastool Check
    # ========================================
    - name: Check OneIdentity vastool
      tags: [vastool, auth]
      block:
        - name: Check if vastool is installed
          ansible.builtin.command: which vastool
          register: vastool_installed
          changed_when: false
          ignore_errors: true

        - name: Get vastool version
          ansible.builtin.shell: vastool -v
          register: vastool_version
          changed_when: false
          ignore_errors: true
          when: vastool_installed is succeeded

        - name: Check vastool status
          ansible.builtin.shell: vastool status
          register: vastool_status
          changed_when: false
          ignore_errors: true
          when: vastool_installed is succeeded

        - name: Check vastool joined domains
          ansible.builtin.shell: vastool domains
          register: vastool_domains
          changed_when: false
          ignore_errors: true
          when: vastool_installed is succeeded

        - name: Check vastool license status
          ansible.builtin.shell: vastool license -s
          register: vastool_license
          changed_when: false
          ignore_errors: true
          when: vastool_installed is succeeded

        - name: Check host joined status
          ansible.builtin.shell: vastool info domain
          register: vastool_domain_info
          changed_when: false
          ignore_errors: true
          when: vastool_installed is succeeded

        - name: Store vastool information
          ansible.builtin.set_fact:
            vastool_info:
              installed: "{{ vastool_installed is succeeded }}"
              version: "{{ vastool_version.stdout_lines | default([]) if vastool_installed is succeeded else [] }}"
              status: "{{ vastool_status.stdout_lines | default([]) if vastool_installed is succeeded else [] }}"
              domains: "{{ vastool_domains.stdout_lines | default([]) if vastool_installed is succeeded else [] }}"
              license: "{{ vastool_license.stdout_lines | default([]) if vastool_installed is succeeded else [] }}"
              domain_info: "{{ vastool_domain_info.stdout_lines | default([]) if vastool_installed is succeeded else [] }}"

      rescue:
        - name: Log vastool check failure
          ansible.builtin.debug:
            msg: "OneIdentity vastool check failed or not installed"

    # ========================================
    # LINBIT Storage (DRBD/linstor) Check
    # ========================================
    - name: Check LINBIT Storage (DRBD and linstor)
      tags: [drbd, linstor, storage]
      block:
        - name: Check if DRBD is installed
          ansible.builtin.command: which drbdadm
          register: drbd_installed
          changed_when: false
          ignore_errors: true

        - name: Get DRBD version
          ansible.builtin.shell: drbdadm --version
          register: drbd_version
          changed_when: false
          ignore_errors: true
          when: drbd_installed is succeeded

        - name: Check DRBD status
          ansible.builtin.shell: drbdadm status
          register: drbd_status
          changed_when: false
          ignore_errors: true
          when: drbd_installed is succeeded

        - name: Check DRBD resources
          ansible.builtin.shell: drbdadm dump all
          register: drbd_resources
          changed_when: false
          ignore_errors: true
          when: drbd_installed is succeeded

        - name: Check if linstor is installed
          ansible.builtin.command: which linstor
          register: linstor_installed
          changed_when: false
          ignore_errors: true

        - name: Get linstor version
          ansible.builtin.shell: linstor --version
          register: linstor_version
          changed_when: false
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Check linstor controller status
          ansible.builtin.service:
            name: linstor-controller
            state: started
          register: linstor_controller_status
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Check linstor satellite status
          ansible.builtin.service:
            name: linstor-satellite
            state: started
          register: linstor_satellite_status
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Get linstor node list
          ansible.builtin.shell: linstor node list
          register: linstor_nodes
          changed_when: false
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Get linstor resource list
          ansible.builtin.shell: linstor resource list
          register: linstor_resources
          changed_when: false
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Get linstor storage pool list
          ansible.builtin.shell: linstor storage-pool list
          register: linstor_storage_pools
          changed_when: false
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Get linstor volume list
          ansible.builtin.shell: linstor volume list
          register: linstor_volumes
          changed_when: false
          ignore_errors: true
          when: linstor_installed is succeeded

        - name: Store LINBIT Storage information
          ansible.builtin.set_fact:
            linbit_storage_info:
              drbd_installed: "{{ drbd_installed is succeeded }}"
              drbd_version: "{{ drbd_version.stdout_lines | default([]) if drbd_installed is succeeded else [] }}"
              drbd_status: "{{ drbd_status.stdout_lines | default([]) if drbd_installed is succeeded else [] }}"
              drbd_resources: "{{ drbd_resources.stdout_lines | default([]) if drbd_installed is succeeded else [] }}"
              linstor_installed: "{{ linstor_installed is succeeded }}"
              linstor_version: "{{ linstor_version.stdout_lines | default([]) if linstor_installed is succeeded else [] }}"
              linstor_controller_active: "{{ linstor_controller_status is defined and not linstor_controller_status.failed if linstor_installed is succeeded else false }}"
              linstor_satellite_active: "{{ linstor_satellite_status is defined and not linstor_satellite_status.failed if linstor_installed is succeeded else false }}"
              linstor_nodes: "{{ linstor_nodes.stdout_lines | default([]) if linstor_installed is succeeded else [] }}"
              linstor_resources: "{{ linstor_resources.stdout_lines | default([]) if linstor_installed is succeeded else [] }}"
              linstor_storage_pools: "{{ linstor_storage_pools.stdout_lines | default([]) if linstor_installed is succeeded else [] }}"
              linstor_volumes: "{{ linstor_volumes.stdout_lines | default([]) if linstor_installed is succeeded else [] }}"

      rescue:
        - name: Log LINBIT storage check failure
          ansible.builtin.debug:
            msg: "LINBIT Storage check failed or not installed"

    # ========================================
    # Generate Final Report
    # ========================================
    - name: Create audit report directory
      tags: [report, always]
      ansible.builtin.file:
        path: "{{ audit_output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Generate audit report
      tags: [report, always]
      ansible.builtin.template:
        src: ../templates/server_audit_report.j2
        dest: "{{ audit_output_dir }}/{{ inventory_hostname }}_audit_{{ ansible_date_time.date }}.txt"
      delegate_to: localhost

    - name: Show summary
      tags: [report, always]
      ansible.builtin.debug:
        msg: |
          Server audit completed for {{ inventory_hostname }}
          Report saved to: {{ audit_output_dir }}/{{ inventory_hostname }}_audit_{{ ansible_date_time.date }}.txt
